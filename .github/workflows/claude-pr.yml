name: Claude Code (PR Review)

on:
  pull_request_review:
    types: [submitted]
  issue_comment:
    types: [created]

concurrency:
  group: claude-pr-${{ github.event.pull_request.number || github.event.issue.number }}
  cancel-in-progress: true

jobs:
  claude:
    if: |
      (github.event_name == 'pull_request_review' &&
        (github.event.pull_request.user.login == 'claude[bot]' ||
         contains(github.event.review.body, '@claude'))) ||
      (github.event_name == 'issue_comment' &&
        github.event.issue.pull_request &&
        contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout PR branch
        run: gh pr checkout ${{ github.event.pull_request.number || github.event.issue.number }}
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          additional_permissions: |
            actions: read
          prompt: |
            You are running autonomously via github action. You were triggered by
            a review or comment on PR #${{ github.event.pull_request.number || github.event.issue.number }}
            in ${{ github.repository }}.

            ## Getting started

            Read the PR with its reviews and comments:
              gh pr view ${{ github.event.pull_request.number || github.event.issue.number }} --json title,body,comments,reviews,labels

            Read inline review comments (these are not included in gh pr view):
              gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number || github.event.issue.number }}/comments --jq '.[] | {path, line, original_line, side, body, user: .user.login, in_reply_to_id}'

            Use git to understand what the PR changed (e.g. git diff, git log).

            Read any linked issues referenced in the PR body (look for #N references):
              gh issue view <number> --json title,body,comments,labels

            Always post a new tracking comment (never reuse one from a previous run):
              gh pr comment ${{ github.event.pull_request.number || github.event.issue.number }} --body "Starting work..."

            Update this comment as you work using:
              gh pr comment ${{ github.event.pull_request.number || github.event.issue.number }} --edit-last --body "<updated content>"

            Use checklist format (- [ ] / - [x]) in your tracking comment to show progress.
            Update after each significant step â€” reading the PR, making each change,
            running tests, iterating on failures, pushing. The comment is the only way humans can see your progress.

            ## Your task

            Address the review feedback. Read the review comments carefully, make the
            requested changes, and push to the PR branch.

            When done:
              1. Push with: git push origin HEAD
              2. Update your tracking comment with a summary of changes made.
          claude_args: |
            --model claude-opus-4-6
            --permission-mode acceptEdits
            --allowedTools "Bash(gh pr view:*),Bash(gh pr comment:*),Bash(gh issue view:*),Bash(gh api repos/Crazytieguy/coven/pulls/*/comments *),Bash(git push origin HEAD)"
            --disallowedTools TodoWrite
